@*
    Harrison1 COSC 470 2019

    File = Appointment.razor

    Author = Christian Slater

    Date = 2019-11-19

    License = MIT

    Modification History

    Version        Author                   Date                    Desc
    v 1.0        Christian Slater        2019-11-19            Refactored Appointments with table
    -->
*@
@page "/appointment"

@using System.Net
@using HarrisPharmacy.App.Data
@using HarrisPharmacy.App.Data.Entities.Patients
@using HarrisPharmacy.App.Data.Entities.Appointments
@using HarrisPharmacy.App.Data.Interfaces
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Mvc.Rendering
@using Microsoft.Data.SqlClient
@inject IAppointmentService AppointmentService
@inject ApplicationDbContext Context

<h3>Appointments</h3>
<h5>Please select a Patient</h5>
@if (PatientsList == null)
{
    <p><em>Loading...</em></p>
}
else if (PatientsList.Count == 0)
{
    <p>No patients to display</p>
}
else
{
    <div class="row" style="padding-top:10px">
        <div class="col-md-4">
            <select @bind="@PatientId" class="form-control">
                <option value="">-- Choose Patient --</option>
                @foreach (var patient in PatientsList)
                {
                    <option value="@patient.PatientId">@patient.FirstName @patient.LastName</option>
                }
            </select>
        </div>
    </div>

}
<h5>User Id</h5>
<input class="form-control" @bind="@UserId" type="text" placeholder="User Id" />
<h5>Start Time</h5>
<div class="input-group date" id="datetimepicker1" data-target-input="nearest">
    <input @bind="@StartTime" type="text" class="form-control datetimepicker-input" data-target="#datetimepicker1" />
    <div class="input-group-append" data-target="#datetimepicker1" data-toggle="datetimepicker">
        <div class="input-group-text"><i class="fa fa-calendar"></i></div>
    </div>
</div>

<h5>End Time</h5>
<div class="input-group date" id="datetimepicker2" data-target-input="nearest">
    <input @bind="@EndTime" type="text" class="form-control datetimepicker-input" data-target="#datetimepicker2" />
    <div class="input-group-append" data-target="#datetimepicker2" data-toggle="datetimepicker">
        <div class="input-group-text"><i class="fa fa-calendar"></i></div>
    </div>
</div>

<h5>Location</h5>
<input class="form-control" @bind="@Location" type="text" placeholder="Location" />
<h5>Description</h5>
<input class="form-control" @bind="@Description" type="text" placeholder="Description" />
<br />
<button @onclick="@CreateAppointment" class="btn btn-warning">Add Appointment</button>
<h5>Delete Appointment</h5>
@if (AppointmentList == null)
{
    <p><em>Loading...</em></p>
}
else if (AppointmentList.Count == 0)
{
    <p>No Appointments to display</p>
}
else
{
    <div class="row" style="padding-top:10px">
        <div class="col-md-4">
            <select @bind="@Delete" class="form-control">
                <option value="">-- Choose Appointment --</option>
                @foreach (var appt in AppointmentList)
                {
                    <option value="@appt.AppointmentId">@appt.PatientId @appt.Description</option>
                }
            </select>
        </div>
    </div>

}

<br />
<button @onclick="@DeleteAppointment" class="btn btn-warning">Delete Appointment</button>

@code {
    public List<Patient> PatientsList;
    public Patient PatientSelected;
    public SelectListItem Item { get; set; } = null!;
    public List<Appointment> AppointmentList;

    private string PatientId { get; set; }
    private string UserId { get; set; }
    private string StartTime { get; set; }
    private string EndTime { get; set; }
    private string Location { get; set; }
    private string Description { get; set; }
    private string Delete { get; set; }

    protected override async Task OnInitializedAsync()
    {
        PatientsList = await AppointmentService.GetPatientsAsync();
        AppointmentList = await AppointmentService.GetPatientListAsync();
    }

    /// <summary>
    /// Inserts a new Appointment into the db using appointment service
    /// </summary>
    /// <returns></returns>
    protected async Task CreateAppointment()
    {
        Appointment appointment = new Appointment()
        {
            AppointmentId = Guid.NewGuid().ToString(),
            UserId = UserId,
            StartTime = StartTime,
            EndTime = EndTime,
            PatientId = PatientId,
            Location = Location,
            Description = Description,
        };
        await AppointmentService.InsertAsync(appointment);
        ClearFields();
        await OnInitializedAsync();
    }
    /// <summary>
    /// Delete an Appointment from the db
    /// </summary>
    /// <returns></returns>
    protected async Task DeleteAppointment()
    {
        await AppointmentService.DeleteAsync(Delete);
        ClearFields();
        await OnInitializedAsync();
    }
    protected async void PatientChosen(ChangeEventArgs e)
    {
        PatientSelected = await AppointmentService.GetPatientAsync(e.Value.ToString());
        this.StateHasChanged();
    }
    /// <summary>
    /// Clear fields on the page
    /// </summary>
    protected void ClearFields()
    {
        UserId = string.Empty;
        StartTime = string.Empty;
        EndTime = string.Empty;
        Location = string.Empty;
        Delete = string.Empty;
        Description = string.Empty;
    }
}